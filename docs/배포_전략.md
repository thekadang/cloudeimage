# 배포 전략

> **목적**: 안전하고 효율적인 데스크톱 앱 배포 프로세스 구축
> **핵심 원칙**: 코드 서명, 자동화, 사용자 편의성
> **최종 업데이트**: 2025-10-23
> **참조**: `추가사항.md`

---

## 🎯 배포 전략 개요

### 주요 과제
1. **코드 서명 (Code Signing)**: Windows Defender 차단 방지
2. **패키징 (Packaging)**: 실행 파일 생성
3. **자동 업데이트 (Auto Update)**: 버전 관리 및 배포
4. **다운로드 배포**: 웹사이트 및 앱 스토어

---

## 🔐 코드 서명 (최우선 과제)

### 중요성

**코드 서명이 없으면**:
- ❌ Windows Defender가 "바이러스"로 차단
- ❌ SmartScreen에서 "알 수 없는 게시자" 경고
- ❌ 사용자가 설치조차 할 수 없음
- ❌ 신뢰도 하락 → 다운로드 포기

**코드 서명을 하면**:
- ✅ Windows Defender 통과
- ✅ 신뢰할 수 있는 게시자 표시
- ✅ 사용자 안심하고 설치
- ✅ 전문성 제고

### Windows 코드 서명 인증서

#### 권장: EV (Extended Validation) 코드 서명 인증서

| 항목 | 내용 |
|------|------|
| **발급 기관** | Sectigo, DigiCert, GlobalSign |
| **비용** | 연 $300-$500 (약 40-65만원) |
| **유효 기간** | 1-3년 |
| **SmartScreen 우회** | 즉시 (EV 인증서 장점) |
| **필요 서류** | 사업자 등록증, 신분증, 전화 인증 |

#### 일반 코드 서명 vs EV 코드 서명

| 항목 | 일반 코드 서명 | EV 코드 서명 |
|------|--------------|------------|
| **비용** | $100-$200/년 | $300-$500/년 |
| **SmartScreen** | 평판 누적 필요 (수개월) | 즉시 우회 |
| **신뢰도** | 보통 | 높음 |
| **권장 여부** | △ | ✅ 강력 권장 |

### 인증서 발급 절차

1. **사업자 등록** (개인 사업자 또는 법인)
2. **인증 기관 선택** (Sectigo 추천)
3. **신청서 작성** 및 서류 제출
4. **전화 인증** (영문 가능자 필요)
5. **USB 토큰 수령** (EV 인증서 전용)
6. **인증서 설치** 및 테스트

### macOS 코드 서명

| 항목 | 내용 |
|------|------|
| **필요 항목** | Apple Developer ID |
| **비용** | $99/년 (개인), $299/년 (조직) |
| **공증 (Notarization)** | 필수 (macOS Catalina 이상) |
| **서명 도구** | Xcode Command Line Tools |

---

## 📦 패키징 (Packaging)

### PyInstaller vs Nuitka

| 항목 | PyInstaller | Nuitka |
|------|------------|--------|
| **속도** | 보통 | 빠름 (C 컴파일) |
| **크기** | 큼 (50-100MB) | 작음 (20-50MB) |
| **난이도** | 쉬움 | 중간 |
| **안정성** | 높음 | 높음 |
| **권장** | ✅ 권장 (초기) | △ 선택 (최적화 시) |

### PyInstaller 설정

#### 기본 명령어
```bash
# 단일 파일 생성
pyinstaller --onefile --windowed main.py

# 아이콘 포함
pyinstaller --onefile --windowed --icon=resources/icon.ico main.py

# 추가 데이터 포함
pyinstaller --onefile --windowed --icon=resources/icon.ico \
    --add-data="resources;resources" main.py
```

#### .spec 파일 (고급 설정)

```python
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['src/main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('resources', 'resources'),
        ('README.md', '.'),
    ],
    hiddenimports=[
        'PIL._webp',  # WebP 지원
        'pillow_avif_plugin',  # AVIF 지원
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='ImageConverter',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,  # 압축 활성화
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,  # 콘솔 창 숨김
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='resources/icon.ico',  # 아이콘
    version_file='version_info.txt',  # 버전 정보
)
```

#### version_info.txt (Windows 버전 정보)

```
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(1, 0, 0, 0),
    prodvers=(1, 0, 0, 0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo(
      [
      StringTable(
        u'040904B0',
        [StringStruct(u'CompanyName', u'ImageConverter Co.'),
        StringStruct(u'FileDescription', u'이미지 변환기'),
        StringStruct(u'FileVersion', u'1.0.0.0'),
        StringStruct(u'InternalName', u'ImageConverter'),
        StringStruct(u'LegalCopyright', u'© 2025 ImageConverter. All rights reserved.'),
        StringStruct(u'OriginalFilename', u'ImageConverter.exe'),
        StringStruct(u'ProductName', u'이미지 변환기'),
        StringStruct(u'ProductVersion', u'1.0.0.0')])
      ]),
    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
  ]
)
```

---

## ✍️ 코드 서명 스크립트

### Windows 서명 (signtool)

```bash
# scripts/sign_windows.bat

@echo off
echo Windows 코드 서명 시작...

REM 환경 변수에서 인증서 정보 가져오기
set CERT_FILE=%WINDOWS_CERTIFICATE%
set CERT_PASSWORD=%WINDOWS_CERT_PASSWORD%
set TIMESTAMP_URL=http://timestamp.digicert.com

REM signtool 경로 (Windows SDK)
set SIGNTOOL="C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

REM 서명 실행
%SIGNTOOL% sign /f %CERT_FILE% /p %CERT_PASSWORD% /tr %TIMESTAMP_URL% /td sha256 /fd sha256 dist\ImageConverter.exe

if %ERRORLEVEL% EQU 0 (
    echo ✅ 코드 서명 성공!
) else (
    echo ❌ 코드 서명 실패!
    exit /b 1
)

REM 서명 검증
%SIGNTOOL% verify /pa dist\ImageConverter.exe

if %ERRORLEVEL% EQU 0 (
    echo ✅ 서명 검증 성공!
) else (
    echo ❌ 서명 검증 실패!
    exit /b 1
)

echo 완료!
```

### macOS 서명 (codesign)

```bash
# scripts/sign_macos.sh

#!/bin/bash
echo "macOS 코드 서명 시작..."

# 환경 변수에서 인증서 정보 가져오기
CERT_IDENTITY="$APPLE_CERTIFICATE"
APP_PATH="dist/ImageConverter.app"

# 서명 실행
codesign --deep --force --verify --verbose \
    --sign "$CERT_IDENTITY" \
    --options runtime \
    --timestamp \
    "$APP_PATH"

if [ $? -eq 0 ]; then
    echo "✅ 코드 서명 성공!"
else
    echo "❌ 코드 서명 실패!"
    exit 1
fi

# 서명 검증
codesign --verify --deep --strict --verbose=2 "$APP_PATH"

if [ $? -eq 0 ]; then
    echo "✅ 서명 검증 성공!"
else
    echo "❌ 서명 검증 실패!"
    exit 1
fi

# 공증 (Notarization)
echo "공증 시작..."
xcrun notarytool submit "$APP_PATH" \
    --apple-id "$APPLE_ID" \
    --password "$APPLE_PASSWORD" \
    --team-id "$APPLE_TEAM_ID" \
    --wait

if [ $? -eq 0 ]; then
    echo "✅ 공증 성공!"

    # 공증 티켓 스테이플
    xcrun stapler staple "$APP_PATH"
    echo "✅ 스테이플 완료!"
else
    echo "❌ 공증 실패!"
    exit 1
fi

echo "완료!"
```

---

## 🚀 자동 업데이트 시스템

### 버전 체크 API

```python
# Lambda Function: /api/version

import json

def get_version(event, context):
    """
    최신 버전 정보 반환

    Response:
        {
            "latest_version": "1.1.0",
            "download_url": "https://imageconverter.com/download/v1.1.0",
            "release_notes": "버그 수정 및 성능 개선",
            "release_date": "2025-10-30",
            "min_supported_version": "1.0.0"
        }
    """
    return {
        'statusCode': 200,
        'headers': {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*'
        },
        'body': json.dumps({
            'latest_version': '1.1.0',
            'download_url': 'https://imageconverter.com/download/v1.1.0/ImageConverter-Setup.exe',
            'release_notes': '버그 수정 및 성능 개선',
            'release_date': '2025-10-30',
            'min_supported_version': '1.0.0'
        })
    }
```

### 클라이언트 업데이트 체커

```python
# src/utils/updater.py

import requests
import webbrowser
from packaging import version as pkg_version

CURRENT_VERSION = "1.0.0"
VERSION_CHECK_URL = "https://api.imageconverter.com/version"

class UpdateChecker:
    """자동 업데이트 체커"""

    @staticmethod
    def check_for_updates():
        """
        업데이트 확인

        Returns:
            tuple: (업데이트 있음, 최신 버전, 다운로드 URL, 릴리스 노트)
        """
        try:
            response = requests.get(VERSION_CHECK_URL, timeout=5)

            if response.status_code == 200:
                data = response.json()
                latest_version = data['latest_version']

                # 버전 비교
                if pkg_version.parse(latest_version) > pkg_version.parse(CURRENT_VERSION):
                    return (
                        True,
                        latest_version,
                        data['download_url'],
                        data['release_notes']
                    )
                else:
                    return (False, None, None, None)

        except Exception:
            # 네트워크 오류 시 무시
            return (False, None, None, None)

    @staticmethod
    def prompt_update(latest_version, download_url, release_notes):
        """
        업데이트 알림 표시

        Returns:
            bool: 사용자가 다운로드 선택 여부
        """
        from PyQt5.QtWidgets import QMessageBox

        msg = QMessageBox()
        msg.setIcon(QMessageBox.Information)
        msg.setWindowTitle("새로운 버전 출시")
        msg.setText(f"새로운 버전 {latest_version}이 출시되었습니다!")
        msg.setInformativeText(f"릴리스 노트:\n{release_notes}\n\n업데이트하시겠습니까?")
        msg.setStandardButtons(QMessageBox.Yes | QMessageBox.No)
        msg.setDefaultButton(QMessageBox.Yes)

        ret = msg.exec_()

        if ret == QMessageBox.Yes:
            # 다운로드 페이지 열기
            webbrowser.open(download_url)
            return True
        else:
            return False
```

---

## 🌐 배포 채널

### 1. 공식 웹사이트 다운로드

**장점**:
- 직접 제어 가능
- 수수료 없음
- 빠른 배포

**구현**:
- S3 + CloudFront (CDN)
- 다운로드 링크: `https://imageconverter.com/download`

### 2. Microsoft Store (선택)

**장점**:
- 공식 앱 스토어 신뢰도
- 자동 업데이트
- 검색 노출

**단점**:
- 등록 비용: $19 (평생)
- 심사 시간: 1-7일
- 수수료: 앱 가격의 15% (유료 앱일 경우)

**참고**: 무료 앱은 수수료 없음

### 3. Mac App Store (선택)

**장점**:
- macOS 사용자 접근성
- 자동 업데이트

**단점**:
- Apple Developer 계정 필요 ($99/년)
- 샌드박싱 제약
- 심사 엄격

### 4. GitHub Releases

**장점**:
- 무료
- 버전 관리 용이
- API 제공

**구현**:
- 태그 기반 릴리스
- 자동화 가능 (GitHub Actions)

---

## 🤖 CI/CD 파이프라인 (GitHub Actions)

### 빌드 및 배포 자동화

```yaml
# .github/workflows/release.yml

name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0 형태의 태그

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller ImageConverter.spec

      - name: Code sign
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          .\scripts\sign_windows.bat

      - name: Create installer
        run: |
          # NSIS 또는 Inno Setup으로 설치 파일 생성
          iscc installer_script.iss

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ImageConverter-Windows
          path: dist/ImageConverter-Setup.exe

  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build app
        run: |
          pyinstaller ImageConverter.spec

      - name: Code sign and notarize
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          bash scripts/sign_macos.sh

      - name: Create DMG
        run: |
          # create-dmg 또는 hdiutil로 DMG 생성
          create-dmg dist/ImageConverter.app dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ImageConverter-macOS
          path: dist/ImageConverter.dmg

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download Windows artifact
        uses: actions/download-artifact@v3
        with:
          name: ImageConverter-Windows
          path: ./release

      - name: Download macOS artifact
        uses: actions/download-artifact@v3
        with:
          name: ImageConverter-macOS
          path: ./release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/ImageConverter-Setup.exe
            release/ImageConverter.dmg
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws s3 cp release/ImageConverter-Setup.exe s3://imageconverter-downloads/${{ github.ref_name }}/
          aws s3 cp release/ImageConverter.dmg s3://imageconverter-downloads/${{ github.ref_name }}/
```

---

## 📋 배포 체크리스트

### 배포 전 확인 사항
- [ ] 코드 서명 인증서 발급 완료
- [ ] 모든 테스트 통과
- [ ] 버전 번호 업데이트
- [ ] 릴리스 노트 작성
- [ ] 빌드 스크립트 테스트
- [ ] 코드 서명 테스트
- [ ] 보안 스캔 완료
- [ ] 사용자 가이드 업데이트

### 배포 후 확인 사항
- [ ] Windows Defender 통과 확인
- [ ] SmartScreen 경고 없음 확인
- [ ] 다운로드 링크 정상 작동
- [ ] 자동 업데이트 알림 확인
- [ ] 설치 과정 원활 확인
- [ ] 주요 기능 정상 동작 확인
- [ ] 로그인/구독 시스템 확인

---

## 💰 배포 비용 예상

| 항목 | 비용 | 주기 |
|------|------|------|
| **Windows EV 코드 서명** | $400 | 연간 |
| **macOS Developer ID** | $99 | 연간 |
| **S3 스토리지** | $3/월 | 월간 (100GB 기준) |
| **CloudFront CDN** | $10/월 | 월간 (1TB 전송 기준) |
| **GitHub Actions** | 무료 | 무료 (Public repo) |
| **총 예상 비용** | **$670/년 + $156/년** | **약 107만원/년** |

---

## 🚀 배포 로드맵

| 단계 | 기간 | 주요 작업 |
|------|------|-----------|
| **Phase 1: 준비** | 2주 | 코드 서명 인증서 발급, 빌드 스크립트 작성 |
| **Phase 2: 빌드** | 1주 | PyInstaller 설정, 패키징 테스트 |
| **Phase 3: 서명** | 1주 | 코드 서명 적용, 검증 |
| **Phase 4: 자동화** | 1주 | CI/CD 파이프라인 구축 |
| **Phase 5: 베타** | 2주 | 베타 사용자 배포, 피드백 수집 |
| **Phase 6: 정식 출시** | 1주 | 공식 웹사이트 배포 |

---

> **참조 문서**
> - [추가사항.md](../추가사항.md)
> - [task.md](../task.md)
> - [01_보안_가이드라인.md](../01_보안_가이드라인.md)
